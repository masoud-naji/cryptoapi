import React, { useState, useEffect, useCallback, useMemo } from "react";
import "../Styles/inventory.css";
import classes from "../Styles/Card.module.css";
import cardStyle from "../Styles/infoCard.module.css";
import Card from "../UI/Card";
import HighlightWithinTextarea from "react-highlight-within-textarea";
import tablestyle from "../Styles/UsersList.module.css";
import ReactTooltip from "react-tooltip";
import "../UI/Custombootstrap.scss";
import Accordion from "react-bootstrap/Accordion";
import CommonToken from "../Accordions/CommonToken";
import GeneralToken from "../Accordions/GeneralToken";
import MetaSeq from "../Accordions/MetaSeq";
import Anchors from "../Accordions/Anchors";
import Quantifiers from "../Accordions/Quantifiers";
import GroupConst from "../Accordions/GroupConst";
import Characters from "../Accordions/Characters";
import FlagsModifiers from "../Accordions/FlagModifiers";
import Substitutions from "../Accordions/Substitutions";
import AllRegexes from "../Accordions/AllRegexes";
import { useDropzone } from "react-dropzone";
import { conformsTo } from "lodash";
import { motion } from "framer-motion";
import { Helmet } from "react-helmet";
///////////////////////////dropzone style/////////////////////////////
const baseStyle = {
  flex: 1,
  display: "flex",
  flexDirection: "column",
  alignItems: "center",
  padding: "20px",
  borderWidth: 2,
  borderRadius: 10,
  borderColor: "#eeeeee",
  borderStyle: "dashed",
  backgroundColor: "#fafafa",
  color: "#bdbdbd",
  outline: "none",
  transition: "border .24s ease-in-out",
};

const focusedStyle = {
  borderColor: "#2196f3",
};

const acceptStyle = {
  borderColor: "#00e676",
};

const rejectStyle = {
  borderColor: "#ff1744",
};

/////////////////regex test /////////////////////////////

const RegexTest = () => {
  const [value, setValue] = useState(
    `Lorem ipsum dolor, sit amet consectetur adipisicing elit.1 2 3 4 5 6 7 8 9 10 Ipsa goose repellendus itaque reiciendis ab explicabo quasi, dicta temporibus quod tempore quis saepe fugit ut autem dolorem eos incidunt voluptates et veritatis fugiat at. Voluptatem nulla, libero magni architecto tempore laudantium dolorum quam impedit placeat aliquid, et similique, quos consectetur veritatis eligendi id iure quia. Recusandae, ullam quidem vero deserunt perspiciatis eligendi voluptates corporis molestiae ab nesciunt non aperiam necessitatibus nemo nam repellendus provident, fugit iure nobis obcaecati cupiditate quos, libero sequi autem! Dolorem adipisci nesciunt repellat, libero quam cumque aliquid expedita, ipsum illo, numquam autem quos voluptates accusantium? Ex ut fugit, mollitia libero hic optio veniam saepe. Ipsam reprehenderit placeat perspiciatis numquam consequatur? Quaerat deserunt quos aut velit iusto a, doloremque veritatis id tempore. Obcaecati nobis accusamus unde, vel necessitatibus ipsa aspernatur iure ducimus maxime labore a repellendus perferendis ullam. Dignissimos rerum aliquid similique unde, rem numquam tempore minus est sed iste provident quasi sit, veritatis sapiente a repudiandae explicabo consequuntur autem asperiores debitis molestiae? Quam in, aliquam a sapiente ducimus odit? Nemo facilis voluptates officia vel animi alias! Quaerat vel architecto voluptas obcaecati, exercitationem, laborum, minus earum consequatur`
  );
  // const savedInput = localStorage.getItem("inputValue");
  // const initialState =   JSON.parse(savedInput) || "lo[rtyu]em";
  const initialState = "lo[rtyu]em";
  const [searchValue, setSearchValue] = useState(initialState);
  const [searchShowValue, setSearchShowValue] = useState(initialState);
  const [highlightValue, setHighlightValue] = useState();
  const [errormsg, setErrormsg] = useState("");
  const [OpendivFlag, setOpendivFlag] = useState(true);
  const [OpenFlag, setOpenFlag] = useState("i");
  const [clickToken, setClickToken] = useState("");
  const [checkedState, setCheckedState] = useState([
    true,
    false,
    false,
    false,
    false,
  ]);
  const onChange = (value) => setValue(value);

  const checkboxflag = [
    // {
    //   name: "g",
    //   text: "global search (g) Finds all the correspondences rather than stopping after the first match",
    // },
    { name: "i", text: "case insensitive (i) Case is ignored" },
    {
      name: "m",
      text: "multiline (m) Start and end characters (^ and $) are treated as working on each line",
    },
    {
      name: "u",
      text: "unicode (u) Treat the regular expression as a sequence of Unicode code points",
    },
    {
      name: "y",
      text: "sticky (y) Matches only from the index indicated by the lastIndex property of this regular expression",
    },
    {
      name: "s",
      text: "dot all make . match newline too. (s) Dot metacharacter matches all characters, including newlines",
    },
  ];

  /////////////////////////drag and drop file upload/////////////////////////////
  const onDrop = useCallback((acceptedFiles) => {
    console.log(acceptedFiles);
    showFile(acceptedFiles[0]);
  }, []);
  const { getRootProps, getInputProps, isFocused, isDragAccept, isDragReject } =
    useDropzone({
      onDrop,
      accept:
        ".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel,application/xml,text/xml,application/json,text/json,text/plain",
    });

  const style = useMemo(
    () => ({
      ...baseStyle,
      ...(isFocused ? focusedStyle : {}),
      ...(isDragAccept ? acceptStyle : {}),
      ...(isDragReject ? rejectStyle : {}),
    }),
    [isFocused, isDragAccept, isDragReject]
  );

  ////////////////////////////////read file////////////////////////
  // const showFile = async (textFile) => {
  //   console.log(textFile);
  //   const reader = new FileReader();
  //   reader.onloaded = () => {
  //     const textResult  = reader.result;
  //     console.log(textResult.length);
  //     if (!textResult.length) {
  //       setErrormsg("**Not valid Image file!**");
  //       setValue("");
  //       return;
  //     }
  //     try {
  //       setValue(textResult);
  //       setUploadedvalue(textResult);
  //     } catch (error) {
  //       setErrormsg("**Not valid Image file!**");
  //       setValue("");
  //       return;
  //     }
  //   };
  //   reader.readAsText(textFile);
  // };

  const frmtarry = [
    ".csv",
    ".json",
    ".JSON",
    ".txt",
    ".js",
    ".ts",
    ".jsx",
    ".css",
    ".scss",
  ];
  const showFile = async (e) => {
    console.log(e);
    const name = e.name;
    const lastDot = name.lastIndexOf(".");
    const ext = name.slice(lastDot);
    console.log(ext);
    if (!frmtarry.includes(ext)) {
      alert("File Format is Wrong!");
      return;
    }
    console.log("Go", e.name);
    try {
      const reader = new FileReader();
      reader.onload = async (e) => {
        // const text = e;
        console.log(e.target.result);
        setValue(e.target.result);
      };
      reader.readAsText(e);
    } catch (error) {
      console.error(error);
    }
  };

  ///////////////////////////////////////////////////////////

  RegExp.quote = function (str) {
    return str.replace(/([.?*+^$[\]\\(){}|-])/g, "\\$1");
  }; //https://stackoverflow.com/questions/16168484/javascript-syntax-error-invalid-regular-expression
  var re = new RegExp(RegExp.quote(initialState));

  const searchHandler = (e) => {
    var inputValue = "";
    e ? (inputValue = e.target.value) : (inputValue = initialState);
    setSearchShowValue(inputValue);
    // localStorage.setItem("inputValue", JSON.stringify(inputValue));
    let regExp = "";

    if (
      inputValue.slice(-1) === "|" ||
      (inputValue[0] === "^" && inputValue.length < 2) ||
      (inputValue[0] === "$" && inputValue.length < 2)
    ) {
      console.log("starts with ^ or $ or | in the text");
      try {
        regExp = new RegExp(RegExp.quote(initialState));
        setErrormsg("Empty");
        return false;
      } catch (error) {
        setErrormsg(`${error}`);
        return false;
      }
    }
    if (inputValue !== "") {
      try {
        if ((regExp = new RegExp(inputValue, `g${OpenFlag}`))) {
          setErrormsg("");
          setSearchValue(regExp);
        }
      } catch (error) {
        setErrormsg(`${error}`);
        setSearchValue(" ");
        return false;
      }
    } else if (inputValue === "") {
      console.log("empty");
      try {
        regExp = new RegExp(RegExp.quote(initialState));
        setErrormsg("Empty");
        setSearchValue(regExp);
      } catch (error) {
        setErrormsg(`${error}`);
        setSearchValue(" ");
        return false;
      }
    }
  };

  const handleOnChange = (position) => {
    const updatedCheckedState = checkedState.map((item, index) =>
      index === position ? !item : item
    );
    setCheckedState(updatedCheckedState);
    const totalflag = updatedCheckedState.reduce(
      (newflags, currentState, index) => {
        if (currentState === true) {
          return newflags + checkboxflag[index].name;
        }
        return newflags;
      },
      ""
    );
    setOpenFlag(totalflag);
  };

  const AddToken = (e) => {
    setClickToken(e);
    setSearchValue(searchValue + e);
    setSearchShowValue(searchShowValue + e);
  };

  useEffect(() => {
    setHighlightValue(searchValue);
  }, [searchValue, OpenFlag, errormsg]);

  useEffect(() => {
    searchHandler();
  }, []);

  return (
    <motion.div
      initial={{ opacity: 0 }}
      animate={{ opacity: 1 }}
      exit={{ opacity: 0 }}
      transition={{ duration: 2 }}
    >
      <Helmet>
        <title>Regex tester</title>
        <meta
          name="description"
          content="Regular expressions are a ubiquitous part of programming languages. Learn how they work, how to write them, and how to use them in practice."
        />
        <meta
          name="description"
          content="Learn how to use regular expressions to make your everyday life easier."
        />
        <meta
          name="description"
          content="A regex test is a tool that lets you test on a regular expression, which is a pattern you type into a text field. It's used to check for a specific pattern in the text."
        />
      </Helmet>
      <Card className={`${classes.input} ${classes.topchartdetail}`}>
        <div className={classes.HeroPlace}>
          {/* ///////////////////////////////////test left/////////////// */}
          <div className={classes.infodisplay}>
            <h1 className={tablestyle.title}>Regex Test</h1>
            <h2 className={tablestyle.smallsubtitle}>
              A regex test is a tool that lets you test on a regular expression,
              which is a pattern you type into a text field. It's used to check
              for a specific pattern in the text. Regular expressions are a
              ubiquitous part of programming languages.Learn how to use regular
              expressions to make your everyday life easier.
            </h2>

            <div
              style={{ background: "rgba(54, 162, 235, 1)" }}
              // className={`${cardStyle.container} $`}
              className={classes.card}
            >
              {/* ////////////////////////////  regex //////////////////////////////// */}
              <div className={cardStyle.tableContainer}>
                <input
                  type="text"
                  value={searchShowValue}
                  onChange={searchHandler}
                  style={{
                    width: "80%",
                    borderRadius: "8px 0 0 8px",
                    borderRight: "0",
                  }}
                />
                <input
                  type="text"
                  value={`/g${OpenFlag}`}
                  readOnly
                  style={{
                    width: "20%",
                    borderRadius: "0 8px 8px 0",
                    borderLeft: "0",
                  }}
                />
                {/* <button onClick={() => setOpendivFlag(!OpendivFlag)} style={{width:"20%"}}>
                  Flasgs
                </button> */}
              </div>
              {/* ////////////////////////////  error //////////////////////////////// */}
              <div
                className={cardStyle.tableContainer}
                style={{ color: "red" }}
              >
                <hr />
                {/* {clickToken} */}
                {errormsg ? (
                  errormsg
                ) : (
                  <section style={{ color: "black" }}>Choose the flag</section>
                )}
              </div>
              {/* ///////////////////////////////////////// flags////////////////////// */}

              <div
                className={classes.tableContainer}
                style={{ display: OpendivFlag !== true ? "none" : "block" }}
              >
                <hr />
                <ul>
                  <li key={1}>
                    <input type="checkbox" checked disabled /> global search (g)
                    Finds all the correspondences rather than stopping after the
                    first match
                  </li>
                  {checkboxflag.map(({ name, text }, index) => (
                    <li key={index}>
                      <input
                        type="checkbox"
                        name={name}
                        id={`custom-checkbox-${index}`}
                        checked={checkedState[index]}
                        onChange={() => handleOnChange(index, name)}
                      />
                      &nbsp;
                      <label htmlFor={`custom-checkbox-${index}`}>{text}</label>
                    </li>
                  ))}
                </ul>
              </div>
              {/* ////////////////////////////  free //////////////////////////////// */}
              <div className={cardStyle.tableContainer}></div>

              {/* ////////////////////////////   //////////////////////////////// */}
            </div>
          </div>
        </div>

        {/* ////////////////////////////  Browose resultFile //////////////////////////////// */}

        <hr />
        <div className={cardStyle.regextexandhelp}>
          {/* ////////////////////////////  accordion //////////////////////////////// */}
          <div className={cardStyle.tableContainer}>
            <Accordion>
              <Accordion.Item eventKey="0">
                <Accordion.Header>Common Tokens</Accordion.Header>
                <Accordion.Body>
                  <CommonToken setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="1">
                <Accordion.Header>General Token</Accordion.Header>
                <Accordion.Body>
                  <GeneralToken setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="2">
                <Accordion.Header>Anchors</Accordion.Header>
                <Accordion.Body>
                  <Anchors setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="3">
                <Accordion.Header>Meta Sequences</Accordion.Header>
                <Accordion.Body>
                  <MetaSeq setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="4">
                <Accordion.Header>Quantifiers</Accordion.Header>

                <Accordion.Body>
                  <Quantifiers setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="5">
                <Accordion.Header>Group Constructs</Accordion.Header>
                <Accordion.Body>
                  <GroupConst setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="6">
                <Accordion.Header>characters Classes</Accordion.Header>
                <Accordion.Body>
                  <Characters setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="7">
                <Accordion.Header>Flags/Modifiers</Accordion.Header>
                <Accordion.Body>
                  <FlagsModifiers setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="8">
                <Accordion.Header>Substitutions</Accordion.Header>
                <Accordion.Body>
                  <Substitutions setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>

              <Accordion.Item eventKey="9">
                <Accordion.Header>All Regex Tokens</Accordion.Header>
                <Accordion.Body>
                  <AllRegexes setClickToken={AddToken} />
                </Accordion.Body>
              </Accordion.Item>
            </Accordion>
          </div>
          <div
            className={classes.regixText}
            // data-for="main"
            // data-tip="Drag 'n' drop some files here, or click to select files or  write or copy your text here then you can check the regex on it"
          >
            <hr />
            <div className={cardStyle.tableContainerdragndrop}>
              <div {...getRootProps({ style })}>
                <input {...getInputProps()} />
                <p>Drag 'n' drop a file here, or click to select file</p>
                <p style={{ wordBreak: "break-word" }}>
                  .xlsx ,.xlsm ,.xlsb ,.xls ,.xlw ,.xlr ,.csv ,.json ,.doc
                  ,.docx ,.xml
                </p>
                Text Below is editable and could write or copy your text here
                then you can check the regex on it
              </div>
            </div>
            <hr />
            <HighlightWithinTextarea
              value={value}
              onChange={onChange}
              highlight={highlightValue}
              style={{
                width: "600px",
                textAlign: "justify",
                textJustify: "inter-word",
              }}
            />
          </div>
        </div>

        <ReactTooltip
          id="main"
          multiline={true}
          place="bottom"
          type="info"
          effect="float"
          className="customeTheme"
        />
      </Card>
    </motion.div>
  );
};

export default RegexTest;
